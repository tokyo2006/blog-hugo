---
date: 2023-11-25
title: "运维眼中的CD流程"
description: "运维眼中的CD流程"
Section: post
Slug: 运维眼中的CD流程
Topics:
 - Devops
Tags:
 - devops
 - lifecycle
 - shell 
 - jenkins
 - buildkite
 - Github Actions
---

    CD（Continues  Deployment）指的就是可持续性部署软件，由于一直从事的是互联网企业，所以涉及的软件部署都是Web应用，在敏捷开发中，应用总是在不停地迭代，在迭代的过程中也是不停地在各个环境中更新部署迭代的版本，在持续部署中，我们同样也应该遵循一套部署流程来保证我们应用的可用性。
<!--more-->

## CD流程涉及的环境

对于大多数公司来说，部署的环境会有好几个，分别是：

- 开发环境
- 集成测试环境
- UAT环境
- 产线环境

### 开发环境

通常来说开发环境既可以是本地环境，也可以是远程的环境，特别是微服务流行起来以后，随着微服务的增多，本地开发环境对机器的性能要求也越来越高，但是如果使用远程环境则对网络的要求很高，所以说鱼与熊掌难以兼得。下面是我知道的几种开发方式。

1. 全本地开发，所有服务都在本地启动，开发只需要在本地编译调试。
2. 自己开发的服务本地，其它服务远程，需要本地服务和远程服务协同。
3. 全远程开发，所有的服务都在远程，且远程提供代码编写和编译的环境，类似于github的code space。

对于Devops来说，需要给开发提供一套工具可以让开发快速的部署调试自己的程序，这样对开发只需要关注自己的业务逻辑即可。

### 集成测试环境

这个环境通常用来做集成测试使用。由于敏捷开发是不停地迭代开发并部署，对集成测试环境的可用性也是有一定要求的。

### QA环境（可选）

对于有测试团队的公司，这个环境只会有测试团队使用，测试出来的问题都会提交ticket给负责相应服务的团队。对于开发即测试的公司，那么开发环境和集成测试环境就充当着QA的环境

### UAT环境

UAT环境已经和产线环境差别不大了，只是版本会比产线的要新，并且这个环境是交给真实客户使用的，他们会使用里面的新功能并反馈问题给产品，产品部门会把客户的反馈提交给负责服务的团队。

### 产线环境

对于产线环境，最重要的就是高可用，高稳定。一旦出现问题就必须立马解决，对于敏捷开发来说，部署的周期会因为公司的不同而不同，有的公司迭代快，可能一周一部署一个版本，有的可能一月部署一个版本。而对于出现问题的时候还会涉及到回滚的操作和快速hotfix的操作。

## 环境部署的流程

### 集成测试环境的部署

这里有两种情况：

1. 开发每个PR都会跑一次集成测试。  
这种方式无疑是尽可能的保证开发的功能在部署到QA或者是UAT环境是可靠的，这里有一个问题就是随着开发规模的增大，集成测试的时间也会越久，这里对集成测试的优化也要求更高，否则一个PR合并的时间就会很长，也会影响开发的效率。
2. 只有在合并到开发分支的时候进行集成测试。
如果测试不通过则自动revert这个PR。这里的问题是有可能合并到开发分支的更新有可能会被别的开发签出到自己的本地分支中。  

### 产线环境的部署

这里有三种情况：

1. 每个发布周期对产品环境进行部署。

- 每个服务都有自己的发布周期。这样的产品环境通常都能很快的响应客户的回应并能尽快的上线新的功能。
- 所有服务使用统一的发布周期。在同一时间发布所有的服务，无疑对运维人员来说有不少的压力，特别是遇到有些个别服务出现问题需要回滚的情况。

1. 对产线出现的问题做快速修复。
1. 对产线出现的问题进行回滚。

## 服务部署的工具

随着软件规模的越来越大，越来越复杂，从之前使用简单的shell脚本或者其它手动的部署脚本已经不能满足日益复杂的软件部署环境，特别是微服务架构流行以后，会面临不同的语言，不同的编译方式，不同的打包方式，这对运维来说都面临着挑战。正是因为这样的需求，各种持续部署的工具就应运而生了。
使用不同的工具相互配合使得软件的部署不在变得繁复和不可维护，而且部署的效率也大大的提高，特别是在一切皆为代码的思想下，所有的部署方式也能以版本管理的方式来进行统一的维护，这样也更方便运维对部署的服务进行快速的更新。

常用的部署工具有以下这些：

### 配置管理类

- puppet
- ansible
- chief
- helm

### 基础设施类

- terraform
- pulumi
- aws cdk

### 部署类

- Jenkins
- ArgoCD
- Rundeck
- GitHub Action
- Buildkite
